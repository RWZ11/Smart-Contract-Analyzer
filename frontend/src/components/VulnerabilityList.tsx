import { useState } from 'react';
import { Vulnerability, InformationalFinding } from '@/types/report';
import VulnerabilityCard from './VulnerabilityCard';
import { Filter, AlertTriangle, Info } from 'lucide-react';

interface VulnerabilityListProps {
  vulnerabilities: Vulnerability[];
  informationalFindings: InformationalFinding[];
}

type SeverityFilter = 'All' | 'High' | 'Medium' | 'Low' | 'Informational';

export default function VulnerabilityList({ vulnerabilities, informationalFindings }: VulnerabilityListProps) {
  const [filter, setFilter] = useState<SeverityFilter>('All');

  // 合并所有发现
  const allFindings = [
    ...vulnerabilities,
    ...informationalFindings,
  ];

  // 按严重级别排序
  const severityOrder = { 'High': 0, 'Medium': 1, 'Low': 2, 'Informational': 3 };
  const sortedFindings = [...allFindings].sort((a, b) => {
    return severityOrder[a.severity] - severityOrder[b.severity];
  });

  // 过滤
  const filteredFindings = filter === 'All' 
    ? sortedFindings 
    : sortedFindings.filter(f => f.severity === filter);

  // 统计数量
  const counts = {
    All: allFindings.length,
    High: vulnerabilities.filter(v => v.severity === 'High').length,
    Medium: vulnerabilities.filter(v => v.severity === 'Medium').length,
    Low: vulnerabilities.filter(v => v.severity === 'Low').length,
    Informational: informationalFindings.length,
  };

  const filterButtons: { label: string; value: SeverityFilter; color: string }[] = [
    { label: '全部', value: 'All', color: 'text-gray-300 hover:bg-gray-700' },
    { label: '高危', value: 'High', color: 'text-red-400 hover:bg-red-500/20' },
    { label: '中危', value: 'Medium', color: 'text-yellow-400 hover:bg-yellow-500/20' },
    { label: '低危', value: 'Low', color: 'text-blue-400 hover:bg-blue-500/20' },
    { label: '信息性', value: 'Informational', color: 'text-gray-400 hover:bg-gray-500/20' },
  ];

  return (
    <div className="space-y-4">
      {/* 过滤器 */}
      <div className="bg-surface p-4 rounded-lg border border-gray-700">
        <div className="flex items-center gap-2 mb-3 text-gray-400">
          <Filter size={18} />
          <span className="font-medium">按严重级别筛选</span>
        </div>
        <div className="flex flex-wrap gap-2">
          {filterButtons.map(({ label, value, color }) => (
            <button
              key={value}
              onClick={() => setFilter(value)}
              className={`px-4 py-2 rounded-lg border transition-colors ${
                filter === value
                  ? 'border-primary bg-primary/20 text-primary'
                  : `border-gray-700 ${color}`
              }`}
            >
              {label} ({counts[value]})
            </button>
          ))}
        </div>
      </div>

      {/* 漏洞列表 */}
      <div className="space-y-4">
        {filteredFindings.length > 0 ? (
          <>
            <div className="flex items-center justify-between text-sm text-gray-400">
              <span>显示 {filteredFindings.length} 个结果</span>
            </div>
            {filteredFindings.map((finding) => (
              <VulnerabilityCard key={finding.id} vulnerability={finding} />
            ))}
          </>
        ) : (
          <div className="text-center py-12 text-gray-400">
            <div className="w-16 h-16 bg-gray-700/50 rounded-full flex items-center justify-center mx-auto mb-4">
              {filter === 'All' ? <Info size={32} /> : <AlertTriangle size={32} />}
            </div>
            <div className="font-medium mb-1">
              {filter === 'All' ? '未发现任何问题' : `未发现 ${filter} 级别的问题`}
            </div>
            <div className="text-sm">
              {filter === 'All' 
                ? '该合约通过了所有安全检测规则'
                : '请选择其他筛选条件查看结果'}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
